Parameters:
  LambdaARN:
    Description: ARN to the Saltstack::Custom Lambda function
    Type: String
  Password:
    Description: Password for the test-ping-user
    Type: String
    NoEcho: true
Resources:
  SaltStackRun:
    Type: Custom::SaltStack
    Properties:
      ServiceToken: 
        Ref: LambdaARN
      SaltClient: local
      SaltUrl: http://172.31.17.15:8000
      Eauth: pam
      Username: cloudformation
      Password:
        Ref: Password
      Target: ip-172-31-27-20.us-west-2.compute.internal
      ExprForm: glob
      Function: state.apply
      Arguments: haproxy-formula
      Pillar: '{"haproxy":{"cloudformation":{"enabled":true,"overwrite":true,"config_file_path":"/etc/haproxy/conf.d/cloudformation.cfg","frontends":{"cloudformation-1":{"name":"cloudformation-1","bind":"*:81","default_backend":"cloudformation-1"}},"backends":{"cloudformation-1":{"balance":"roundrobin","servers":{"cloudformaiton-1":{"host":"10.10.10.10","port":81}}}}}}}'
Outputs:
  SaltStackHaproxy:
    Description: State output from haproxy-formula
    Value: !GetAtt SaltStackRun.ip-172-31-27-20.us-west-2.compute.internal
